<?xml version="1.0"?>
<!--
 -
 -  $Id$
 -
 -  This file is part of the OpenLink Software Virtuoso Open-Source (VOS)
 -  project.
 -
 -  Copyright (C) 1998-2006 OpenLink Software
 -
 -  This project is free software; you can redistribute it and/or modify it
 -  under the terms of the GNU General Public License as published by the
 -  Free Software Foundation; only version 2 of the License, dated June 1991.
 -
 -  This program is distributed in the hope that it will be useful, but
 -  WITHOUT ANY WARRANTY; without even the implied warranty of
 -  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 -  General Public License for more details.
 -
 -  You should have received a copy of the GNU General Public License along
 -  with this program; if not, write to the Free Software Foundation, Inc.,
 -  51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
 -
-->
<v:page name="conversation" decor="template/popup.vspx" style="template/template.xsl" fast-render="1" xmlns:v="http://www.openlinksw.com/vspx/" xmlns:vm="http://www.openlinksw.com/vspx/macro" doctype="-//W3C//DTD XHTML 1.0 Transitional//EN" doctype-system="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
      <v:method name="getTitle" arglist="">
        <![CDATA[
          declare title any;

      if (isnull(self.v_pid))
      {
            select EFI_TITLE into title from ENEWS.WA.FEED_ITEM where EFI_ID = self.v_fid;
          } else {
            select EFIC_TITLE into title from ENEWS.WA.FEED_ITEM_COMMENT where EFIC_ID = self.v_pid;
          }
          return concat('Re: ', coalesce(title, '~ no title ~'));
        ]]>
      </v:method>

      <v:method name="getComment" arglist="">
        <![CDATA[
          declare comment any;

      if (isnull(self.v_pid))
      {
            select EFI_TITLE into comment from ENEWS.WA.FEED_ITEM where EFI_ID = self.v_fid;
          } else {
            select EFIC_COMMENT into comment from ENEWS.WA.FEED_ITEM_COMMENT where EFIC_ID = self.v_pid;
          }
          return coalesce(comment, '');
        ]]>
      </v:method>

  <vm:pagetitle>Discussion page</vm:pagetitle>
      <vm:popup_page_wrapper>
        <vm:variables>
          <v:variable persist="0" name="v_mode" type="varchar" default="'show'"/>
          <v:variable persist="0" name="v_fid" param-name="fid" type="integer"/>
          <v:variable persist="0" name="v_did" param-name="did" type="integer"/>
          <v:variable persist="0" name="v_aid" param-name="aid" type="integer"/>
          <v:variable persist="0" name="v_pid" type="integer"/>
      <v:variable persist="temp" name="openid_sig" type="varchar" default="null" param-name="oid_sig"/>
      <v:variable persist="temp" name="openid_key" type="varchar" default="null" param-name="oid_key"/>
        </vm:variables>
    <vm:pagebody>
          <div class="new-form-header">
        Discussion
          </div>
          <div class="new-form-body">
            <table cellspacing="0">
              <tr>
                <td>
              <div class="comment-section">Item</div>
                  <v:label value="">
                    <v:after-data-bind>
                      <![CDATA[
                        control.ufl_value := (select coalesce(EFI_TITLE, '~ no title ~') from ENEWS.WA.FEED_ITEM where EFI_ID = self.v_fid);
                      ]]>
                    </v:after-data-bind>
                  </v:label>
              <div class="comment-button">
                <v:button action="simple" value="Reply" xhtml_title="Reply" xhtml_class="button">
                  <v:on-post>
                    <![CDATA[
                      self.v_pid := null;
                      self.v_mode := 'reply';
                      self.vc_data_bind(e);
                    ]]>
                  </v:on-post>
                </v:button>
              </div>
                </td>
              </tr>
          <?vsp
            if (exists (select 1 from ENEWS.WA.FEED_ITEM_COMMENT where EFIC_ITEM_ID = self.v_fid and EFIC_PARENT_ID is not null))
            {
          ?>
              <tr>
                <td>
              <div class="comment-section">Comments</div>
                  <v:tree name="comments_list" multi-branch="1" orientation="vertical" start-path="--self.v_fid" open-at="--'//*'" root="ENEWS.WA.cm_root_node"	child-function="ENEWS.WA.cm_child_node">
	                  <v:node-template name="node_tmpl">
	                    <div class="<?V case when control.tn_level = 0 then 'cm_node_top' else 'cm_node' end ?>">
                    		<?vsp
                      		{
                      		  declare id, comment, title, u_name, last_update any;

                      		  id := cast (control.tn_value as integer);
                      		  declare exit handler for not found;
                      		  select EFIC_TITLE, EFIC_COMMENT, EFIC_U_NAME, EFIC_LAST_UPDATE
                      		    into title, comment, u_name, last_update
                      		    from ENEWS.WA.FEED_ITEM_COMMENT
                      		   where EFIC_ID = id;
                         
                        declare parsed_message any;
                        declare _print_body,d_name varchar;
                        declare idx integer;

                        parsed_message := ENEWS.WA.news_comment_get_mess_attachments (comment, 0);
                        
                        _print_body := parsed_message[0];
                        comment:=_print_body;
                        
                        comment:=comment||'<br/>';
                        idx := 1;
                        while (idx < length (parsed_message))
                        {
	                         d_name := parsed_message[idx];
	                           comment:=comment||sprintf ('Download attachment : <a target="_BLANK" href="%senews2/%d/attachment.vsp?id=%d&part=%i&fn=%s">%s</a><br/>',
                                                        WA_LINK(1,'/'),
                                                        self.v_did,
                                                        id,
                                                        idx,
                                                        d_name,
                                                        d_name);
	                         if (d_name like '%.jpg' or d_name like '%.gif' or d_name like '%.png')
	                         {
	                           comment:=comment||sprintf ('<img alt="attachment" src="%senews2/%d/attachment.vsp?id=%d&part=%i&fn=%s" />',
                                                       WA_LINK(1,'/'),
                                                       self.v_did,
                                                       id,
                                                       idx,
                                                       d_name);
	                           comment:=comment||'<br/>';
	                         }
	                         idx := idx + 1;
                        }
                      	?>
	                      <div class="comment" id="msg_<?V id ?>">
		                      <div class="comment-header">
			                      <span class="comment-subj"><?V title ?></span> <br />
		                      </div>
		                      <div class="comment-msg">
                            <?vsp
                              http (comment);
                            ?>
	                        </div>
	                        <div class="comment-footer">
		                        <span class="comment-user">
		                          Posted by <?V ENEWS.WA.utf2wide (u_name) ?>
		                        </span>
                        <span class="comment-date"> on <?V ENEWS.WA.dt_value (last_update) ?></span>
	                        </div>
                      <div class="comment-button">
                        <v:button action="simple" value="Reply" xhtml_title="Reply" xhtml_class="button">
                          <v:on-post>
                            <![CDATA[
                              self.v_pid := cast ((control.vc_parent as vspx_tree_node).tn_value as integer);;
                              self.v_mode := 'reply';
                              self.vc_data_bind(e);
                            ]]>
                          </v:on-post>
                        </v:button>
                        <v:button action="simple" value="Delete" xhtml_title="Delete" xhtml_onclick="return confirmAction(\'Are you sure that you want to delete this comment?\');" xhtml_class="button">
                              <v:on-post>
                                <![CDATA[
                              declare id integer;

                              id := cast ((control.vc_parent as vspx_tree_node).tn_value as integer);
                              delete from ENEWS.WA.FEED_ITEM_COMMENT where EFIC_ID = id;

                                  self.v_mode := 'show';
                                  self.vc_data_bind(e);
                                ]]>
                              </v:on-post>
                            </v:button>
                          </div>
                       </div>
		                   <?vsp
		                     }
		                   ?>
		                   <v:node />
	                    </div>
	                  </v:node-template>
                  </v:tree>
                </td>
              </tr>
          <?vsp
            }
          ?>
              <tr>
                <td>
              <div class="comment-button"></div>
                </td>
              </tr>
              <v:template type="simple" enabled="--case when (self.v_mode = 'reply') then 1 else 0 end">
                <tr>
                  <td>
                    <table cellspacing="0">
                      <tr>
                    <td colspan="2">
                      <div class="comment-section">Reply</div>
                    </td>
                  </tr>
                  <tr>
                        <th>
                          <v:label for="f_name" value="Name" />
                        </th>
                        <td>
                      <v:text name="f_name" xhtml_id="f_name" value="--ENEWS.WA.account_fullName (self.v_aid)" xhtml_class="textbox" xhtml_size="50" />
                        </td>
                      </tr>
                      <tr>
                        <th>
                          <v:label for="f_mail" value="E-Mail" />
                        </th>
                        <td>
                      <v:text name="f_mail" xhtml_id="f_mail" value="--ENEWS.WA.account_mail(self.v_aid)" xhtml_class="textbox" xhtml_size="50" />
                        </td>
                      </tr>
                      <tr>
                        <th>
                      <v:label for="openid_url" value="Web Site" />
		      <span id='img'>
		        <img src="<?V case when length (self.openid_sig) then 'image/login-bg.gif' else '' end ?>"
			     width="16"
			     height="16"
			     hspace="1"
			     style="<?V case when length (self.openid_sig) then '' else 'display: none;' end ?>" />
		      </span>
                    </th>
                    <td>
   		      <v:text name="oid_key" value="--self.openid_key" type="hidden" xhtml_id="oid_key" />
		      <v:text name="oid_sig" value="--self.openid_sig" type="hidden" xhtml_id="oid_sig" />
		      <v:text name="openid_url" xhtml_id="openid_url" value="" xhtml_size="50" xhtml_class="textbox" />
		      <input type='button' value='Verify' id='verify_button' onclick="javascript: onClickVerify(event);" class="button" />
                      <span id='msg'></span>
                    </td>
                  </tr>
                  <tr>
                    <th>
                          Comment
                        </th>
                        <td>
                          <?vsp
                            declare tmpString any;
                            tmpString := self.getComment();
                            tmpString := replace(tmpString, '\'', '&#39;');
                            tmpString := replace(tmpString, '"', '&#34;');
                            tmpString := replace(tmpString, chr(10), ' ');
                            tmpString := replace(tmpString, chr(13), ' ');
                          ?>
                          <![CDATA[
                            <script language="JavaScript" type="text/javascript" src="rte/js/richtext.js"></script>
                            <script language="JavaScript" type="text/javascript" src="rte/js/html2xhtml.js"></script>
                            <script language="JavaScript" type="text/javascript">
                              initRTE("rte/images/", "rte/js/", "", true);
                            </script>
                            <noscript><p><b>Javascript must be enabled to use this form.</b></p></noscript>
                            <script language="JavaScript" type="text/javascript">
                              writeRichText('f_message', '<?vsp http(tmpString); ?>', 500, 170, true, false);
                            </script>
                          ]]>
                        </td>
                      </tr>
                      <tr>
                        <td colspan="2" align="center">
                      <div class="comment-button">
                      <v:button action="simple" value="Post" xhtml_onclick="javascript:updateRTE(\'f_message\')" xhtml_title="Post" xhtml_class="button">
                            <v:on-post>
                              <![CDATA[
                            declare name, mail, url, title, comment any;
                                declare rName, rMail, rTitle, rComment any;

                                title := self.getTitle();
                                comment := trim(get_keyword('f_message', self.vc_event.ve_params, ''));
                                name := trim(self.f_name.ufl_value);
                                mail := trim(self.f_mail.ufl_value);
                            url := trim(self.openid_url.ufl_value);

                            if (isnull(self.v_pid))
                            {
                                  -- get root comment;
                                  self.v_pid := (select EFIC_ID from ENEWS.WA.FEED_ITEM_COMMENT where EFIC_DOMAIN_ID = self.v_did and EFIC_ITEM_ID = self.v_fid and EFIC_PARENT_ID is null);
                              if (isnull(self.v_pid))
                              {
                                ENEWS.WA.nntp_root (self.v_did, self.v_fid);
                                self.v_pid := (select EFIC_ID from ENEWS.WA.FEED_ITEM_COMMENT where EFIC_DOMAIN_ID = self.v_did and EFIC_ITEM_ID = self.v_fid and EFIC_PARENT_ID is null);
                              }
                                }

                                ENEWS.WA.nntp_update_item (self.v_did, self.v_fid);
                            insert into ENEWS.WA.FEED_ITEM_COMMENT (EFIC_PARENT_ID, EFIC_DOMAIN_ID, EFIC_ITEM_ID, EFIC_TITLE, EFIC_COMMENT, EFIC_U_NAME, EFIC_U_MAIL, EFIC_U_URL, EFIC_LAST_UPDATE, EFIC_OPENID_SIG)
                              values (self.v_pid, self.v_did, self.v_fid, title, comment, name, mail, url, now (), self.oid_sig.ufl_value || '&mac_key=' || self.oid_key.ufl_value);

                                self.v_mode := 'show';
                                self.vc_data_bind(e);
                              ]]>
                            </v:on-post>
                          </v:button>
                      <v:button action="simple" value="Cancel" xhtml_title="Cancel" xhtml_class="button">
                            <v:on-post>
                              <![CDATA[
                                self.v_mode := 'show';
                                self.vc_data_bind(e);
                              ]]>
                            </v:on-post>
                          </v:button>
                      </div>
                      <div class="comment-button" />
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </v:template>
          <tr>
            <td>
              Subscribe to an RSS feed of this comment thread:
              <?vsp
                http(sprintf('<a href="%sOFM.comment?:id=%d" target="_blank" title="RSS conversation" alt="RSS conversation" class="gems"><img src="image/rss-icon-16.gif" border="0"/></a>', ENEWS.WA.dav_url (self.domain_id), self.v_fid));
              ?>
            </td>
          </tr>
            </table>
          </div>
    </vm:pagebody>
      </vm:popup_page_wrapper>
    </v:page>
