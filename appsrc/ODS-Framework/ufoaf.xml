<?xml version ='1.0' encoding='UTF-8'?>
<!--
 -
 -  $Id$
 -
 -  This file is part of the OpenLink Software Virtuoso Open-Source (VOS)
 -  project.
 -
 -  Copyright (C) 1998-2006 OpenLink Software
 -
 -  This project is free software; you can redistribute it and/or modify it
 -  under the terms of the GNU General Public License as published by the
 -  Free Software Foundation; only version 2 of the License, dated June 1991.
 -
 -  This program is distributed in the hope that it will be useful, but
 -  WITHOUT ANY WARRANTY; without even the implied warranty of
 -  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 -  General Public License for more details.
 -
 -  You should have received a copy of the GNU General Public License along
 -  with this program; if not, write to the Free Software Foundation, Inc.,
 -  51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA
 -
-->
<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" 
    xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#" 
    xmlns:foaf="http://xmlns.com/foaf/0.1/" 
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xml:base="">
    <sql:header xmlns:sql='urn:schemas-openlink-com:xml-sql'>
	<sql:param name=":sne">-1</sql:param>
    </sql:header>
    <foaf:Person rdf:about="">
    <sql:sqlx xmlns:sql='urn:schemas-openlink-com:xml-sql' sql:xsl="foaf.xsl"><![CDATA[
	select
            xmlelement ('http://xmlns.com/foaf/0.1/:nick', wa_utf8_to_wide (u_name)),
	    either (length (WAUI_TITLE),
            xmlelement ('http://xmlns.com/foaf/0.1/:title', either( equ(WA_OPTION_IS_PUBLIC(u_name,0),1), WAUI_TITLE,'' )), NULL),
	    either (length (WAUI_FIRST_NAME),
	    xmlelement ('http://xmlns.com/foaf/0.1/:firstName', either( equ(WA_OPTION_IS_PUBLIC(u_name,1),1), wa_utf8_to_wide (WAUI_FIRST_NAME),'')), NULL),
	    either (length (WAUI_LAST_NAME),
	    xmlelement ('http://xmlns.com/foaf/0.1/:family_name', either(equ(WA_OPTION_IS_PUBLIC(u_name,2),1), wa_utf8_to_wide (WAUI_LAST_NAME),'')), NULL),
	    either (length (u_full_name),
	    xmlelement ('http://xmlns.com/foaf/0.1/:name', wa_utf8_to_wide (u_full_name)), NULL),
	    either (length (u_e_mail) * equ(WA_OPTION_IS_PUBLIC(u_name,4),1),
	    xmlelement ('http://xmlns.com/foaf/0.1/:mbox', xmlattributes ('mailto:'||either( equ(WA_OPTION_IS_PUBLIC(u_name,4),1), u_e_mail,'') as 'http://www.w3.org/1999/02/22-rdf-syntax-ns#:resource')), NULL),
	    either (length (WAUI_GENDER) * equ(WA_OPTION_IS_PUBLIC(u_name,5),1),
	    xmlelement ('http://xmlns.com/foaf/0.1/:gender', either( equ(WA_OPTION_IS_PUBLIC(u_name,5),1), WAUI_GENDER ,'')), NULL),
	    either (length (WAUI_ICQ),
            xmlelement ('http://xmlns.com/foaf/0.1/:icqChatID', either( equ(WA_OPTION_IS_PUBLIC(u_name,10),1), WAUI_ICQ,'')), NULL),
	    either (length (WAUI_MSN),
            xmlelement ('http://xmlns.com/foaf/0.1/:msnChatID', either( equ(WA_OPTION_IS_PUBLIC(u_name,14),1), WAUI_MSN,'')), NULL),
	    either (length (WAUI_AIM),
            xmlelement ('http://xmlns.com/foaf/0.1/:aimChatID', either( equ(WA_OPTION_IS_PUBLIC(u_name,12),1), WAUI_AIM,'')), NULL),
	    either (length (WAUI_YAHOO),
	    xmlelement ('http://xmlns.com/foaf/0.1/:yahooChatID', either( equ(WA_OPTION_IS_PUBLIC(u_name,13),1), WAUI_YAHOO,'')), NULL),

	    either ( equ(WA_OPTION_IS_PUBLIC (u_name, 37),1) * length (WAUI_PHOTO_URL), 
	    xmlelement ('http://xmlns.com/foaf/0.1/:depiction', 
	    xmlattributes ( 'http://' || WA_GET_HOST () || WAUI_PHOTO_URL as 'http://www.w3.org/1999/02/22-rdf-syntax-ns#:resource')
	       ),
	    null),
	    
	    either ( equ(WA_OPTION_IS_PUBLIC (u_name, 6), 1) * equ(isnull (WAUI_BIRTHDAY), 0),  
	    xmlelement ('http://xmlns.com/foaf/0.1/:birthday', substring (datestring(coalesce (WAUI_BIRTHDAY, now())), 6, 5)),
	    null ),
	    
	    either ( length (WA_USER_TAG_GET (u_name)),
	    ( 
	       select xmlagg (xmlelement ('http://xmlns.com/foaf/0.1/:interest', 
	         xmlelement ('http://www.w3.org/1999/02/22-rdf-syntax-ns#:Description', 
	           xmlattributes (U_TAG as 'http://www.w3.org/2000/01/rdf-schema#:label'))
		)) 
	       from WA_USER_TAG_GET_P (uname) (U_TAG varchar) P where uname = u_name 
	    )  
	    ,
	    null),
	    
	    either ( equ(WA_OPTION_IS_PUBLIC (u_name, 20), 1) * length (WAUI_BORG), 
	    xmlelement ('http://xmlns.com/foaf/0.1/:organization', WAUI_BORG),
	    null),
	    
	    either ( equ(WA_OPTION_IS_PUBLIC (u_name, 18), 1) * (length(WAUI_HPHONE) + length (WAUI_HMOBILE) + length (WAUI_BPHONE)), 
	    xmlelement ('http://xmlns.com/foaf/0.1/:phone', 
		   xmlattributes (
		   'tel:' || case 
		      when length (WAUI_HPHONE) then WAUI_HPHONE 
		      when length (WAUI_HMOBILE) then WAUI_HMOBILE 
		      else  WAUI_BPHONE end 
		      as 'http://www.w3.org/1999/02/22-rdf-syntax-ns#:resource')
	        ),
	    null),
	    
	    either ( equ(isnull (WAUI_LAT)+isnull(WAUI_LNG),0),
	    xmlelement ('http://xmlns.com/foaf/0.1/:based_near',
	      xmlelement ('http://www.w3.org/2003/01/geo/wgs84_pos#:Point',
	        xmlattributes (
	              sprintf ('%.06f', coalesce (case when WAUI_LATLNG_HBDEF=0 THEN WAUI_LAT ELSE WAUI_BLAT end, 0)) as 'http://www.w3.org/2003/01/geo/wgs84_pos#:lat',
	              sprintf ('%.06f', coalesce (case when WAUI_LATLNG_HBDEF=0 THEN WAUI_LNG ELSE WAUI_BLNG end, 0)) as 'http://www.w3.org/2003/01/geo/wgs84_pos#:long'
		    )
	         )), NULL), 
	    
	    either(length (WAUI_WEBPAGE), 
	    xmlelement ('http://xmlns.com/foaf/0.1/:homepage',
	          xmlattributes ( either( equ(WA_OPTION_IS_PUBLIC(u_name,7),1), WAUI_WEBPAGE,'') as 'http://www.w3.org/1999/02/22-rdf-syntax-ns#:resource')), null)
	    from sn_person, sys_users, WA_USER_INFO where sne_org_id = u_id and u_id = WAUI_U_ID
	    and sne_id = :sne
	    ]]></sql:sqlx>

    <sql:sqlx xmlns:sql='urn:schemas-openlink-com:xml-sql'><![CDATA[
	select xmlelement ('http://xmlns.com/foaf/0.1/:knows',
	       xmlelement ('http://xmlns.com/foaf/0.1/:Person',
                 xmlattributes ('http://'|| WA_GET_HOST ()|| '/dataspace/' || u_name  as 'http://www.w3.org/1999/02/22-rdf-syntax-ns#:about'),
 	                   either ( length (u_full_name) , 
	                    xmlelement ('http://xmlns.com/foaf/0.1/:name', wa_utf8_to_wide (u_full_name)), null),
			    xmlelement ('http://xmlns.com/foaf/0.1/:nick', wa_utf8_to_wide (u_name)),

			    xmlelement ('http://www.w3.org/2000/01/rdf-schema#:seeAlso',
			    	xmlattributes (
			    	'http://'|| WA_GET_HOST ()|| '/dataspace/' || u_name || '/about.rdf'
			    	as 'http://www.w3.org/1999/02/22-rdf-syntax-ns#:resource'))

			    ))
			    from (
			     select u_id,u_full_name,u_name from sn_person, sn_related, sys_users where sne_org_id = u_id
			     and sne_id = snr_to and snr_from = :sne
			     union
			     select u_id,u_full_name,u_name from sn_person, sn_related, sys_users where sne_org_id = u_id
			     and sne_id = snr_from and snr_to = :sne
			     ) sub
	]]></sql:sqlx>
    <sql:sqlx xmlns:sql='urn:schemas-openlink-com:xml-sql'><![CDATA[
      select 
      xmlelement ('http://openlinksw.com/ods/1.0/:'|| wa_type_to_appg (tname), 
      xmlelement ('http://www.w3.org/1999/02/22-rdf-syntax-ns#:Seq', 
      xmlattributes ('http://'|| WA_GET_HOST ()|| '/dataspace/' || uname || '/' || wa_type_to_app (tname) 
			as 'http://www.w3.org/1999/02/22-rdf-syntax-ns#:about'),
	   (

	  select xmlagg (
	   xmlelement ('http://www.w3.org/1999/02/22-rdf-syntax-ns#:li',
	   xmlattributes ( 'http://'||WA_GET_HOST ()|| '/dataspace/' || U_NAME || '/' || wa_type_to_app (WAI_TYPE_NAME) || sprintf 
	   ('/%U', wa_utf8_to_wide (WAI_NAME)) as 'http://www.w3.org/1999/02/22-rdf-syntax-ns#:resource')

		))
		from (select WAI_TYPE_NAME,WAI_NAME,WAI_DESCRIPTION,U_NAME from WA_MEMBER, WA_INSTANCE, sn_entity, SYS_USERS where WAM_INST = WAI_NAME and WAM_USER = U_ID and sne_name = u_name and sne_id = :sne and WAM_MEMBER_TYPE = 1 and WAI_TYPE_NAME = tname order by 1) sub
		)
		)
		)
	from (select distinct WAI_TYPE_NAME as tname, U_FULL_NAME as fname, U_NAME as uname from WA_MEMBER, WA_INSTANCE, sn_entity, SYS_USERS where WAM_INST = WAI_NAME and WAM_USER = U_ID and sne_name = u_name and sne_id = :sne and WAM_MEMBER_TYPE = 1) sub2 
	]]></sql:sqlx>
    <sql:sqlx xmlns:sql='urn:schemas-openlink-com:xml-sql'><![CDATA[
	select xmlelement ('http://www.w3.org/2000/01/rdf-schema#:seeAlso',
	xmlattributes ('http://'||WA_GET_HOST ()|| '/dataspace/' || U_NAME || '/sioc.rdf' as 'http://www.w3.org/1999/02/22-rdf-syntax-ns#:resource')),
	xmlelement ('http://www.w3.org/2000/01/rdf-schema#:seeAlso',
	xmlattributes ('http://'||WA_GET_HOST ()|| '/sparql/' as 'http://www.w3.org/1999/02/22-rdf-syntax-ns#:resource'))
          from sn_entity, SYS_USERS where sne_name = U_NAME and sne_id = :sne
	]]></sql:sqlx>
  </foaf:Person>
    <sql:sqlx xmlns:sql='urn:schemas-openlink-com:xml-sql'><![CDATA[
	  select 
	  xmlelement ('http://openlinksw.com/ods/1.0/:'||wa_type_to_app (WAI_TYPE_NAME),
	  xmlattributes ('http://'||WA_GET_HOST ()|| '/dataspace/' || U_NAME || '/' || wa_type_to_app (WAI_TYPE_NAME) 
	  || sprintf ('/%U' , wa_utf8_to_wide (WAI_NAME)) as 'http://www.w3.org/1999/02/22-rdf-syntax-ns#:about'),
		xmlelement ('http://purl.org/dc/elements/1.1/:title', wa_utf8_to_wide (WAI_NAME)),
		xmlelement ('http://purl.org/dc/elements/1.1/:description', wa_utf8_to_wide (WAI_DESCRIPTION)),
		xmlelement ('http://www.w3.org/2000/01/rdf-schema#:seeAlso',
		xmlattributes ('http://'||WA_GET_HOST ()|| '/dataspace/' || U_NAME || '/' || wa_type_to_app (WAI_TYPE_NAME) || sprintf ('/%U', wa_utf8_to_wide (WAI_NAME))  || '/about.rdf' as 'http://www.w3.org/1999/02/22-rdf-syntax-ns#:resource')),
		xmlelement ('http://www.w3.org/2000/01/rdf-schema#:seeAlso',
		xmlattributes ('http://'||WA_GET_HOST ()|| '/dataspace/' || U_NAME || '/' || wa_type_to_app (WAI_TYPE_NAME) || sprintf ('/%U', wa_utf8_to_wide (WAI_NAME))  || '/sioc.rdf' as 'http://www.w3.org/1999/02/22-rdf-syntax-ns#:resource')),
		xmlelement ('http://openlinksw.com/ods/1.0/:owner',
		xmlattributes ('http://'||WA_GET_HOST ()|| '/dataspace/' || U_NAME || '/about.rdf' as 'http://www.w3.org/1999/02/22-rdf-syntax-ns#:resource'))
		)
		from WA_MEMBER, WA_INSTANCE, sn_entity, SYS_USERS where WAM_INST = WAI_NAME and WAM_USER = U_ID and sne_name = U_NAME and sne_id = :sne and WAM_MEMBER_TYPE = 1 
	]]></sql:sqlx>
</rdf:RDF>
