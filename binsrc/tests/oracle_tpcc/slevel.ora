
create or replace procedure slevel (
    w_id  in integer,
    d_id_  in integer,
    threshold  in integer
	 )
as
  last_o integer; 
  n_items integer;
begin
  set transaction isolation level read committed;

  select d_next_o_id into last_o
    from district
    where d_w_id = w_id and d_id = d_id_; 

  select count (distinct s_i_id) into n_items
    from order_line, stock
    where ol_w_id = w_id
      and ol_d_id = d_id_
      and ol_o_id < last_o
      and ol_o_id >= last_o - 20
      and s_w_id = w_id
      and s_i_id = ol_i_id
      and s_quantity < threshold; 

	commit;
  --dbms_output.put_line(to_char(n_items));
  --result_names (n_items);
  --result (n_items);
end slevel;
/
